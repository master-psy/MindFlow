<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow | 随感与灵感记录</title>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- 引入 Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 配置 Tailwind 主题色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#0f172a',
                        surface: '#1e293b',
                        accent: '#38bdf8',
                        textMain: '#e2e8f0',
                        textMuted: '#94a3b8'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['"Noto Serif SC"', 'serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateX(-10px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* 玻璃拟态效果 */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* 除去点击高亮 */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 加载动画 */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #38bdf8;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 模态框背景 */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-midnight text-textMain min-h-screen font-sans selection:bg-accent selection:text-white flex flex-col items-center">

    <!-- 背景装饰光斑 -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-[128px] opacity-20 animate-pulse" style="animation-duration: 4s;"></div>
    </div>

    <!-- 配置模态框 (默认隐藏) -->
    <div id="configModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-backdrop px-4">
        <div class="glass-panel w-full max-w-lg p-6 rounded-2xl shadow-2xl animate-fade-in-up border border-slate-600">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i class="fa-solid fa-gear text-accent"></i> 服务器配置
            </h2>
            <p class="text-sm text-slate-400 mb-4">
                请配置您的 Firebase 项目信息。数据将存储在您指定的数据库中。
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-300 uppercase mb-1">唯一身份 ID (UID)</label>
                    <input type="text" id="customUidInput" placeholder="例如: my-secret-notebook-001" 
                           class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-accent outline-none">
                    <p class="text-xs text-slate-500 mt-1">用于区分您的数据，请勿泄露。</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-300 uppercase mb-1">Firebase Config (JSON)</label>
                    <textarea id="firebaseConfigInput" rows="6" placeholder='{ "apiKey": "...", "authDomain": "...", "projectId": "..." }'
                              class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white font-mono text-xs focus:ring-2 focus:ring-accent outline-none"></textarea>
                    <p class="text-xs text-slate-500 mt-1">从 Firebase 控制台复制 SDK 配置对象。</p>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="window.app.closeConfigModal()" class="px-4 py-2 text-slate-300 hover:text-white transition-colors">取消</button>
                <button onclick="window.app.saveConfig()" class="px-6 py-2 bg-accent text-white font-bold rounded-lg hover:bg-sky-500 transition-colors">保存并连接</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-6xl px-4 py-8 md:py-12 flex flex-col gap-8 h-screen md:h-auto md:min-h-screen">
        
        <!-- Header 区域 -->
        <header class="flex justify-between items-center animate-fade-in-up">
            <div class="flex flex-col">
                <h1 class="text-3xl md:text-4xl font-serif font-bold tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-cyan-200">
                    MindFlow
                </h1>
                <p class="text-textMuted text-sm mt-1 font-light italic">记录稍纵即逝的思维火花。</p>
            </div>
            <div class="flex gap-3 items-center">
                <!-- 状态指示灯 -->
                <div id="statusIndicator" class="flex items-center gap-2 text-xs text-textMuted mr-2" title="正在连接云端...">
                    <div class="loader w-4 h-4 border-2"></div>
                </div>
                
                <button onclick="window.app.openConfigModal()" title="设置" class="text-textMuted hover:text-white transition-colors p-2">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="window.app.exportData()" title="导出数据" class="text-textMuted hover:text-accent transition-colors p-2">
                    <i class="fa-solid fa-download"></i>
                </button>
                <button onclick="window.app.clearAll()" title="清空所有" class="text-textMuted hover:text-red-400 transition-colors p-2">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </header>

        <!-- 主体内容区域：Grid 布局 -->
        <main class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-10 flex-1 overflow-hidden">
            
            <!-- 左侧：输入区域 -->
            <section class="md:col-span-4 lg:col-span-4 flex flex-col gap-4 animate-fade-in-up" style="animation-delay: 0.1s;">
                <div class="glass-panel rounded-2xl p-6 shadow-xl shadow-black/20 md:sticky md:top-6">
                    <label for="thoughtInput" class="block text-sm font-medium text-accent mb-2 uppercase tracking-wider">
                        <i class="fa-regular fa-pen-to-square mr-2"></i>New Thought
                    </label>
                    <textarea 
                        id="thoughtInput" 
                        rows="6" 
                        placeholder="此刻，你在想什么？..." 
                        class="w-full bg-slate-800/50 text-gray-100 rounded-xl border border-slate-700 p-4 focus:ring-2 focus:ring-accent focus:border-transparent outline-none resize-none transition-all placeholder-slate-500 font-serif leading-relaxed text-lg"
                    ></textarea>
                    
                    <div class="flex justify-between items-center mt-4">
                        <span id="charCount" class="text-xs text-slate-500">0 字</span>
                        <button 
                            onclick="window.app.addThought()" 
                            class="group relative inline-flex items-center justify-center px-6 py-2.5 text-sm font-bold text-white transition-all duration-200 bg-accent rounded-lg hover:bg-sky-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent focus:ring-offset-slate-900 overflow-hidden"
                        >
                            <span class="relative z-10 flex items-center gap-2">
                                记录 <i class="fa-solid fa-paper-plane text-xs transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"></i>
                            </span>
                            <div class="absolute inset-0 h-full w-full bg-gradient-to-r from-cyan-400 to-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </button>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="hidden md:block glass-panel rounded-2xl p-6 mt-4">
                    <h3 class="text-textMuted text-xs uppercase tracking-widest mb-4">Statistics</h3>
                    <div class="flex justify-between items-center">
                        <div class="text-center">
                            <span id="totalNotes" class="block text-2xl font-bold text-white">0</span>
                            <span class="text-xs text-slate-500">篇随笔</span>
                        </div>
                        <div class="h-8 w-[1px] bg-slate-700"></div>
                        <div class="text-center">
                            <span id="totalWords" class="block text-2xl font-bold text-white">0</span>
                            <span class="text-xs text-slate-500">总字数</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 右侧：列表区域 -->
            <section class="md:col-span-8 lg:col-span-8 flex flex-col h-full overflow-hidden animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h2 class="text-lg font-semibold text-textMain flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-accent"></i> Timeline
                    </h2>
                    <div id="syncStatusText" class="text-xs text-emerald-400 bg-emerald-900/20 px-3 py-1 rounded-full border border-emerald-800/50 hidden">
                        <i class="fa-solid fa-cloud"></i> 已同步
                    </div>
                </div>

                <!-- 列表容器 -->
                <div id="notesContainer" class="flex-1 overflow-y-auto pr-2 pb-20 space-y-6 md:pb-0">
                    <!-- 动态生成的内容将放在这里 -->
                    
                    <!-- 空状态占位 -->
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-slate-600 opacity-60">
                        <i class="fa-brands fa-envira text-5xl mb-4"></i>
                        <p class="font-serif italic text-lg">暂无记录，种下第一颗思想的种子吧。</p>
                    </div>
                    
                    <!-- 初始加载中状态 -->
                    <div id="initialLoader" class="flex flex-col items-center justify-center h-64 text-slate-500 hidden">
                        <div class="loader w-8 h-8 border-4 mb-4"></div>
                        <p id="loaderText">正在连接...</p>
                    </div>

                    <!-- 未配置状态 -->
                    <div id="notConfiguredState" class="flex flex-col items-center justify-center h-64 text-slate-500">
                        <i class="fa-solid fa-server text-4xl mb-4 text-slate-700"></i>
                        <p class="mb-4">未配置数据库连接</p>
                        <button onclick="window.app.openConfigModal()" class="px-4 py-2 bg-slate-700 hover:bg-accent text-white text-sm rounded transition-colors">
                            立即配置
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 底部 (仅移动端) 统计 -->
    <div class="md:hidden fixed bottom-0 left-0 w-full glass-panel border-t border-slate-700 p-3 flex justify-around items-center text-xs text-slate-400 z-50">
        <span><b id="mobileTotalNotes" class="text-white">0</b> 篇随笔</span>
        <span><b id="mobileTotalWords" class="text-white">0</b> 总字数</span>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Firebase SDK (ES Modules) -->
    <script type="module">
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        class MindFlowApp {
            constructor() {
                this.data = [];
                this.userId = null; 
                this.customUid = null; // 用户手动设置的ID
                this.app = null;
                this.auth = null;
                this.db = null;
                this.unsubscribe = null;
                this.appId = 'mindflow-v2'; // 固定 App ID 用于路径前缀
                
                // DOM 元素绑定
                this.input = document.getElementById('thoughtInput');
                this.container = document.getElementById('notesContainer');
                this.emptyState = document.getElementById('emptyState');
                this.notConfiguredState = document.getElementById('notConfiguredState');
                this.initialLoader = document.getElementById('initialLoader');
                this.charCount = document.getElementById('charCount');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.syncStatusText = document.getElementById('syncStatusText');
                this.configModal = document.getElementById('configModal');
                
                this.stats = {
                    notes: document.getElementById('totalNotes'),
                    words: document.getElementById('totalWords'),
                    mobileNotes: document.getElementById('mobileTotalNotes'),
                    mobileWords: document.getElementById('mobileTotalWords')
                };

                this.init();
            }

            async init() {
                // 绑定输入事件
                this.input.addEventListener('input', () => this.updateCharCount());
                this.input.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        this.addThought();
                    }
                });

                // 尝试加载保存的配置
                await this.loadConfigAndConnect();
            }

            async loadConfigAndConnect() {
                this.setStatus('loading');
                const savedConfig = localStorage.getItem('mindflow_firebase_config');
                const savedUid = localStorage.getItem('mindflow_custom_uid');

                let config = null;

                if (savedConfig) {
                    try {
                        config = JSON.parse(savedConfig);
                        this.customUid = savedUid || 'default-user';
                    } catch (e) {
                        console.error("Invalid saved config");
                    }
                } 
                
                // 如果本地没有配置，尝试使用环境变量
                if (!config && typeof __firebase_config !== 'undefined') {
                    try {
                        config = JSON.parse(__firebase_config);
                        this.customUid = 'env-user-' + Math.floor(Math.random() * 1000); // 默认ID
                    } catch(e) {}
                }

                if (config) {
                    this.connectFirebase(config);
                } else {
                    this.setStatus('not_configured');
                }
            }

            async connectFirebase(config) {
                try {
                    // 如果已经存在 app，先删除（用于重新配置）
                    if (getApps().length > 0) {
                        // 简单处理：刷新页面是更安全的重置方式，但在单页应用中我们尝试直接初始化
                        // 注意：SDK 可能会抛出 duplicate app 错误，这里假设是首次或刷新后
                    }

                    try {
                        this.app = initializeApp(config);
                    } catch (e) {
                        // 如果 app 已经存在，尝试获取它
                        if(e.code === 'app/duplicate-app') {
                            this.app = getApps()[0];
                        } else {
                            throw e;
                        }
                    }

                    this.auth = getAuth(this.app);
                    this.db = getFirestore(this.app);

                    // 匿名登录以获取访问权限
                    // 注意：你的 Firestore 规则必须允许匿名读写，或者你需要提供有效的 Token
                    // 如果有环境变量提供的 token，优先使用
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(this.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(this.auth);
                    }

                    // 监听 Auth 状态
                    onAuthStateChanged(this.auth, (user) => {
                        if (user) {
                            // Auth 成功，开始监听数据
                            // 我们使用 this.customUid 作为数据存储路径的 ID，而不是 Auth 的随机 UID
                            // 这样用户只要输入相同的 customUid 就能看到数据
                            this.setStatus('online');
                            this.setupRealtimeListener();
                        } else {
                            this.setStatus('offline');
                        }
                    });

                } catch (error) {
                    console.error("Connection Failed:", error);
                    this.showToast("连接失败，请检查配置", "error");
                    this.setStatus('not_configured');
                    this.openConfigModal(); // 自动打开配置窗口
                }
            }

            setupRealtimeListener() {
                // 使用用户设置的 Custom UID 作为路径
                const targetUid = this.customUid || this.auth.currentUser.uid;
                
                // 路径: artifacts/{appId}/users/{customUid}/thoughts
                const thoughtsCollection = collection(this.db, 'artifacts', this.appId, 'users', targetUid, 'thoughts');

                if(this.unsubscribe) this.unsubscribe();

                this.unsubscribe = onSnapshot(thoughtsCollection, (snapshot) => {
                    const loadedData = [];
                    snapshot.forEach(doc => {
                        loadedData.push({ id: doc.id, ...doc.data() });
                    });

                    loadedData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    this.data = loadedData;
                    
                    this.render();
                    this.updateStats();
                }, (error) => {
                    console.error("Snapshot Error:", error);
                    this.showToast("同步断开: " + error.code, "error");
                    this.setStatus('offline');
                });
            }

            // UI 状态管理
            setStatus(status) {
                this.initialLoader.classList.add('hidden');
                this.notConfiguredState.classList.add('hidden');
                this.emptyState.classList.add('hidden');
                this.syncStatusText.classList.add('hidden');

                if (status === 'loading') {
                    this.initialLoader.classList.remove('hidden');
                    this.statusIndicator.innerHTML = '<div class="loader w-4 h-4 border-2"></div>';
                } else if (status === 'online') {
                    this.statusIndicator.innerHTML = '<span class="text-emerald-400"><i class="fa-solid fa-circle text-[8px]"></i> 在线</span>';
                    this.syncStatusText.classList.remove('hidden');
                    this.syncStatusText.innerHTML = `<i class="fa-solid fa-cloud"></i> ID: ${this.customUid}`;
                    if(this.data.length === 0) this.emptyState.classList.remove('hidden');
                } else if (status === 'offline') {
                    this.statusIndicator.innerHTML = '<span class="text-red-400"><i class="fa-solid fa-circle-exclamation"></i> 离线</span>';
                } else if (status === 'not_configured') {
                    this.notConfiguredState.classList.remove('hidden');
                    this.statusIndicator.innerHTML = '<span class="text-slate-500"><i class="fa-solid fa-ban"></i> 未配置</span>';
                }
            }

            // --- 配置相关 ---
            openConfigModal() {
                // 填充当前值
                const currentConfig = localStorage.getItem('mindflow_firebase_config');
                const currentUid = localStorage.getItem('mindflow_custom_uid');
                
                if(currentConfig) {
                    document.getElementById('firebaseConfigInput').value = currentConfig;
                }
                if(currentUid) {
                    document.getElementById('customUidInput').value = currentUid;
                }
                
                this.configModal.classList.remove('hidden');
            }

            closeConfigModal() {
                this.configModal.classList.add('hidden');
            }

            saveConfig() {
                const configStr = document.getElementById('firebaseConfigInput').value.trim();
                const uidStr = document.getElementById('customUidInput').value.trim();

                if(!configStr || !uidStr) {
                    this.showToast("请填写完整信息", "warning");
                    return;
                }

                try {
                    // 验证 JSON 格式
                    JSON.parse(configStr);
                    
                    localStorage.setItem('mindflow_firebase_config', configStr);
                    localStorage.setItem('mindflow_custom_uid', uidStr);
                    
                    this.closeConfigModal();
                    this.showToast("配置已保存，正在重连...", "success");
                    
                    // 简单的重连策略：刷新页面
                    setTimeout(() => window.location.reload(), 1000);
                    
                } catch(e) {
                    this.showToast("Config JSON 格式错误", "error");
                }
            }

            // --- 业务逻辑 ---
            async addThought() {
                if (!this.db || !this.auth) {
                    this.showToast('请先配置服务器连接', 'warning');
                    this.openConfigModal();
                    return;
                }

                const content = this.input.value.trim();
                if (!content) return;

                const btn = document.querySelector('button[onclick="window.app.addThought()"]');
                const originalBtnContent = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                btn.disabled = true;

                try {
                    const targetUid = this.customUid || this.auth.currentUser.uid;
                    const thoughtsCollection = collection(this.db, 'artifacts', this.appId, 'users', targetUid, 'thoughts');
                    
                    await addDoc(thoughtsCollection, {
                        content: content,
                        timestamp: new Date().toISOString(),
                        type: 'text'
                    });

                    this.input.value = '';
                    this.updateCharCount();
                    this.showToast('已同步', 'success');
                } catch (e) {
                    console.error(e);
                    this.showToast('发送失败: ' + e.message, 'error');
                } finally {
                    btn.innerHTML = originalBtnContent;
                    btn.disabled = false;
                }
            }

            async deleteThought(id) {
                if(!confirm('确定删除?')) return;
                try {
                    const targetUid = this.customUid || this.auth.currentUser.uid;
                    await deleteDoc(doc(this.db, 'artifacts', this.appId, 'users', targetUid, 'thoughts', id));
                } catch(e) {
                    this.showToast('删除失败', 'error');
                }
            }

            copyThought(id) {
                const thought = this.data.find(t => t.id === id);
                if (thought) {
                    navigator.clipboard.writeText(thought.content)
                        .then(() => this.showToast('已复制', 'success'))
                        .catch(() => this.showToast('复制失败', 'error'));
                }
            }

            async clearAll() {
                if (this.data.length === 0) return;
                if (!confirm('确定清空所有数据?')) return;
                
                const targetUid = this.customUid || this.auth.currentUser.uid;
                const promises = this.data.map(item => 
                    deleteDoc(doc(this.db, 'artifacts', this.appId, 'users', targetUid, 'thoughts', item.id))
                );
                await Promise.all(promises);
                this.showToast('已清空', 'info');
            }

            exportData() {
                if(this.data.length === 0) return;
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = `mindflow_${this.customUid}_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            }

            updateCharCount() {
                this.charCount.textContent = `${this.input.value.length} 字`;
            }

            updateStats() {
                const count = this.data.length;
                const words = this.data.reduce((acc, curr) => acc + (curr.content ? curr.content.length : 0), 0);
                this.stats.notes.textContent = count;
                this.stats.words.textContent = words;
                this.stats.mobileNotes.textContent = count;
                this.stats.mobileWords.textContent = words;
            }

            formatDate(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                const diff = (new Date() - date) / 1000;
                if (diff < 60) return '刚刚';
                if (diff < 3600) return `${Math.floor(diff / 60)} 分钟前`;
                if (diff < 86400) return `${Math.floor(diff / 3600)} 小时前`;
                return date.toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            render() {
                const children = Array.from(this.container.children);
                children.forEach(child => {
                    if (!['emptyState', 'initialLoader', 'notConfiguredState'].includes(child.id)) child.remove();
                });

                if (this.data.length === 0 && this.statusIndicator.textContent.includes('在线')) {
                    this.emptyState.classList.remove('hidden');
                } else {
                    this.emptyState.classList.add('hidden');
                }

                this.data.forEach((item, index) => {
                    const card = document.createElement('article');
                    card.className = `group relative pl-8 pb-8 border-l-2 border-slate-700 hover:border-accent transition-colors duration-300 animate-fade-in-up`;
                    card.style.animationDelay = `${index * 0.05}s`;
                    
                    card.innerHTML = `
                        <div class="absolute left-[-9px] top-0 w-4 h-4 rounded-full border-4 border-midnight bg-slate-500 group-hover:bg-accent transition-colors duration-300"></div>
                        <div class="glass-panel p-5 rounded-xl hover:bg-slate-800/80 transition-all duration-300">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-xs font-bold text-accent tracking-wide bg-accent/10 px-2 py-0.5 rounded">
                                    ${this.formatDate(item.timestamp)}
                                </span>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-3">
                                    <button onclick="window.app.copyThought('${item.id}')" class="text-slate-500 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                                    <button onclick="window.app.deleteThought('${item.id}')" class="text-slate-500 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                            <div class="prose prose-invert max-w-none">
                                <p class="whitespace-pre-wrap font-serif text-gray-200 leading-relaxed text-base">${this.escapeHtml(item.content)}</p>
                            </div>
                        </div>
                    `;
                    this.container.appendChild(card);
                });
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const colors = { info: 'bg-slate-700', success: 'bg-emerald-600', warning: 'bg-amber-500', error: 'bg-red-500' };
                toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center animate-slide-in backdrop-blur-sm bg-opacity-90`;
                toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check' : 'info-circle'} mr-2"></i> ${message}`;
                document.getElementById('toastContainer').appendChild(toast);
                setTimeout(() => { toast.remove() }, 3000);
            }
        }

        window.app = new MindFlowApp();
    </script>
</body>
</html>
